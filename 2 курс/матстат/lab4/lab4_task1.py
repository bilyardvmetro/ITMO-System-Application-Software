import pandas as pd
import numpy as np
from scipy.stats import t, f

# Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
df = pd.read_csv("kc_house_data.csv")

# Ğ’Ñ‹Ğ±Ğ¾Ñ€ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ…
X_raw = df[['sqft_living', 'sqft_lot', 'sqft_above']]
y = df['price'].to_numpy().reshape(-1, 1)

# Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¼Ğ°Ñ‚Ñ€Ğ¸Ñ†Ñ‹ X Ñ ĞµĞ´Ğ¸Ğ½Ğ¸Ñ†Ğ°Ğ¼Ğ¸
X = np.hstack((np.ones((X_raw.shape[0], 1)), X_raw.to_numpy()))

# ĞÑ†ĞµĞ½ĞºĞ° ĞºĞ¾ÑÑ„Ñ„Ğ¸Ñ†Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ²: b = (X^T X)^-1 X^T y
XtX = X.T @ X
XtX_inv = np.linalg.inv(XtX)
Xty = X.T @ y
beta_hat = XtX_inv @ Xty

# ĞŸÑ€ĞµĞ´ÑĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ñ Ğ¸ Ğ¾ÑÑ‚Ğ°Ñ‚ĞºĞ¸
y_pred = X @ beta_hat
residuals = y - y_pred

# ĞÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ°Ñ Ğ´Ğ¸ÑĞ¿ĞµÑ€ÑĞ¸Ñ
n, k = X.shape
rss = np.sum(residuals ** 2)
sigma2 = rss / (n - k)

# Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ¸ Ğ´Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ»Ñ‹
var_b = sigma2 * XtX_inv
se_b = np.sqrt(np.diag(var_b))
t_crit = t.ppf(0.975, df=n - k)
conf_ints = np.column_stack((beta_hat.flatten() - t_crit * se_b,
                             beta_hat.flatten() + t_crit * se_b))

# R^2
tss = np.sum((y - np.mean(y)) ** 2)
r_squared = 1 - rss / tss

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ³Ğ¸Ğ¿Ğ¾Ñ‚ĞµĞ·
# H0: b1 = 0, b2 = 0 Ğ¾Ğ´Ğ½Ğ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾ (sqft_living Ğ¸ sqft_above)
R = np.array([
    [0, 1, 0, 0],
    [0, 0, 0, 1]
])
q = np.array([[0], [0]])
Rb = R @ beta_hat
middle = np.linalg.inv(R @ XtX_inv @ R.T)
F_stat = ((Rb - q).T @ middle @ (Rb - q)) / R.shape[0] / sigma2
p_value = 1 - f.cdf(F_stat, dfn=R.shape[0], dfd=n - k)

# Ğ’Ñ‹Ğ²Ğ¾Ğ´
print("ĞºĞ¾ÑÑ„Ñ„Ğ¸Ñ†Ğ¸ĞµĞ½Ñ‚Ñ‹ Ğ»Ğ¸Ğ½ĞµĞ¹Ğ½Ğ¾Ğ¹ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸:")
for name, coef, interval in zip(['intercept', 'sqft_living', 'sqft_lot', 'sqft_above'], beta_hat.flatten(), conf_ints):
    print(f"{name:15}: {coef:10.2f}  95%-Ğ´Ğ¾Ğ²ĞµÑ€. Ğ¸Ğ½Ñ‚ĞµÑ€Ğ².: [{interval[0]:.2f}, {interval[1]:.2f}]")

# ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ²Ñ‹Ğ²Ğ¾Ğ´ Ğ¿Ğ¾ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸
names = ['intercept', 'sqft_living', 'sqft_lot', 'sqft_above']
coef_rounded = np.round(beta_hat.flatten(), 2)
print()
print(f"Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ½Ğ°Ñ Ğ»Ğ¸Ğ½ĞµĞ¹Ğ½Ğ°Ñ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ: y^ = {coef_rounded[0]} + ({coef_rounded[1]})*sqft_living + ({coef_rounded[2]})*sqft_lot + ({coef_rounded[3]})*sqft_above\n")

print(f"â€¢ Ğ¿Ñ€Ğ¸ ÑƒĞ²ĞµĞ»Ğ¸Ñ‡ĞµĞ½Ğ¸Ğ¸ Ğ¶Ğ¸Ğ»Ğ¾Ğ¹ Ğ¿Ğ»Ğ¾Ñ‰Ğ°Ğ´Ğ¸ Ğ½Ğ° 1 ĞºĞ². Ñ„ÑƒÑ‚, Ñ†ĞµĞ½Ğ° Ğ² ÑÑ€ĞµĞ´Ğ½ĞµĞ¼ ÑƒĞ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ Ğ½Ğ° {coef_rounded[1]:.2f} Ñƒ.Ğµ.")
print(f"â€¢ Ğ¿Ñ€Ğ¸ ÑƒĞ²ĞµĞ»Ğ¸Ñ‡ĞµĞ½Ğ¸Ğ¸ Ğ¿Ğ»Ğ¾Ñ‰Ğ°Ğ´Ğ¸ ÑƒÑ‡Ğ°ÑÑ‚ĞºĞ° Ğ½Ğ° 1 ĞºĞ². Ñ„ÑƒÑ‚, Ñ†ĞµĞ½Ğ° Ğ² ÑÑ€ĞµĞ´Ğ½ĞµĞ¼ Ğ¸Ğ·Ğ¼ĞµĞ½ÑĞµÑ‚ÑÑ Ğ½Ğ° {coef_rounded[2]:.2f} Ñƒ.Ğµ.")
print(f"â€¢ Ğ¿Ñ€Ğ¸ ÑƒĞ²ĞµĞ»Ğ¸Ñ‡ĞµĞ½Ğ¸Ğ¸ Ğ¿Ğ»Ğ¾Ñ‰Ğ°Ğ´Ğ¸ Ğ½Ğ°Ğ´ Ğ·ĞµĞ¼Ğ»Ñ‘Ğ¹ Ğ½Ğ° 1 ĞºĞ². Ñ„ÑƒÑ‚, Ñ†ĞµĞ½Ğ° Ğ² ÑÑ€ĞµĞ´Ğ½ĞµĞ¼ Ğ¸Ğ·Ğ¼ĞµĞ½ÑĞµÑ‚ÑÑ Ğ½Ğ° {coef_rounded[3]:.2f} Ñƒ.Ğµ.")
print("\nĞ˜Ğ¢ĞĞ“Ğ:")
print(f"- Ğ³Ğ¸Ğ¿Ğ¾Ñ‚ĞµĞ·Ğ° 'Ğ§ĞµĞ¼ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ¶Ğ¸Ğ»Ğ°Ñ Ğ¿Ğ»Ğ¾Ñ‰Ğ°Ğ´ÑŒ, Ñ‚ĞµĞ¼ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ñ†ĞµĞ½Ğ°' {'Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´Ğ°ĞµÑ‚ÑÑ' if beta_hat[1][0] > 0 and (2 * (1 - t.cdf(abs(beta_hat[1][0]/se_b[1]), df=n-k))) < 0.05 else 'ĞĞµ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´Ğ°ĞµÑ‚ÑÑ'}")
print(f"- Ğ³Ğ¸Ğ¿Ğ¾Ñ‚ĞµĞ·Ğ° 'Ğ¦ĞµĞ½Ğ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ñ‚ Ğ¾Ñ‚ Ğ¿Ğ»Ğ¾Ñ‰Ğ°Ğ´Ğ¸ ÑƒÑ‡Ğ°ÑÑ‚ĞºĞ°' {'Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´Ğ°ĞµÑ‚ÑÑ' if (2 * (1 - t.cdf(abs(beta_hat[2][0]/se_b[2]), df=n-k)) < 0.05) else 'ĞĞµ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´Ğ°ĞµÑ‚ÑÑ'}")

# TSS: Total Sum of Squares â€” Ğ¾Ğ±Ñ‰Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ° ĞºĞ²Ğ°Ğ´Ñ€Ğ°Ñ‚Ğ¾Ğ² Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½ĞµĞ½Ğ¸Ğ¹ Ğ¾Ñ‚ ÑÑ€ĞµĞ´Ğ½ĞµĞ³Ğ¾ - Ğ½Ğ°ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ ÑĞ¸Ğ»ÑŒĞ½Ğ¾ Ñ€Ğ°Ğ·Ğ±Ñ€Ğ¾ÑĞ°Ğ½Ñ‹ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ
tss = np.sum((y - np.mean(y)) ** 2)

# RSS: Residual Sum of Squares â€” ÑÑƒĞ¼Ğ¼Ğ° ĞºĞ²Ğ°Ğ´Ñ€Ğ°Ñ‚Ğ¾Ğ² Ğ¾ÑÑ‚Ğ°Ñ‚ĞºĞ¾Ğ² - Ñ‚Ğ¾, Ñ‡Ñ‚Ğ¾ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ Ğ½Ğµ Ğ¾Ğ±ÑŠÑÑĞ½Ğ¸Ğ»Ğ° (Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸)
rss = np.sum((y - y_pred) ** 2)

# RÂ²: ĞºĞ°ĞºĞ°Ñ Ğ´Ğ¾Ğ»Ñ Ğ´Ğ¸ÑĞ¿ĞµÑ€ÑĞ¸Ğ¸ Ğ¾Ğ±ÑŠÑÑĞ½ÑĞµÑ‚ÑÑ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒÑ
r_squared = 1 - (rss / tss)

# ĞĞ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ğ¾: Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ñ€Ğ°ÑĞ¿ĞµÑ‡Ğ°Ñ‚Ğ°Ñ‚ÑŒ Ñ‡Ğ°ÑÑ‚Ğ¸ Ğ¿Ğ¾ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸
print("\nÑ€Ğ°ÑÑ‡ĞµÑ‚ RÂ²:")
print(f"TSS (Ğ¾Ğ±Ñ‰Ğ°Ñ Ğ´Ğ¸ÑĞ¿ĞµÑ€ÑĞ¸Ñ): {tss:.2e}")
print(f"RSS (Ğ½ĞµĞ¾Ğ±ÑŠÑÑĞ½Ñ‘Ğ½Ğ½Ğ°Ñ Ğ´Ğ¸ÑĞ¿ĞµÑ€ÑĞ¸Ñ): {rss:.2e}")
print(f"RÂ² = 1 - RSS / TSS = 1 - {rss:.2e} / {tss:.2e} = {r_squared:.4f}")

print(f"ĞºĞ¾ÑÑ„Ñ„Ğ¸Ñ†Ğ¸ĞµĞ½Ñ‚ Ğ´ĞµÑ‚ĞµÑ€Ğ¼Ğ¸Ğ½Ğ°Ñ†Ğ¸Ğ¸ RÂ² = {r_squared:.4f}")
print("Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ Ğ¾Ğ±ÑŠÑÑĞ½ÑĞµÑ‚ Ñ‡Ğ°ÑÑ‚ÑŒ Ñ€Ğ°Ğ·Ğ±Ñ€Ğ¾ÑĞ°, Ğ¾Ğ´Ğ½Ğ°ĞºĞ¾ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ñ‹ ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ¸Ñ Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¿Ñ€ĞµĞ´ÑĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ñ")
# ğŸ“Š Ğ’Ñ‹Ğ²Ğ¾Ğ´ Ğ¿Ğ¾ F-ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞµ (Ğ³Ğ¸Ğ¿Ğ¾Ñ‚ĞµĞ·Ğ° H0: b1 = b3 = 0)
print("\nĞ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ³Ğ¸Ğ¿Ğ¾Ñ‚ĞµĞ·Ñ‹: Hâ‚€: ĞºĞ¾ÑÑ„Ñ„Ğ¸Ñ†Ğ¸ĞµĞ½Ñ‚Ñ‹ Ğ¿Ñ€Ğ¸ sqft_living Ğ¸ sqft_above Ñ€Ğ°Ğ²Ğ½Ñ‹ Ğ½ÑƒĞ»Ñ")

print(f"F-ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° = {F_stat[0][0]:.2f}")
print(f"p-value = {p_value[0][0]:.4f}")

if p_value[0][0] < 0.05:
    print("Ğ¾Ñ‚Ğ²ĞµÑ€Ğ³Ğ°ĞµĞ¼ Hâ‚€ Ğ½Ğ° ÑƒÑ€Ğ¾Ğ²Ğ½Ğµ Ğ·Ğ½Ğ°Ñ‡Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ 5%: Ñ…Ğ¾Ñ‚Ñ Ğ±Ñ‹ Ğ¾Ğ´Ğ¸Ğ½ Ğ¸Ğ· ĞºĞ¾ÑÑ„Ñ„Ğ¸Ñ†Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ² Ğ·Ğ½Ğ°Ñ‡Ğ¸Ğ¼.")
else:
    print("Ğ½ĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ¾ÑĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ€Ğ³Ğ½ÑƒÑ‚ÑŒ Hâ‚€: Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ½ĞµĞ·Ğ½Ğ°Ñ‡Ğ¸Ğ¼Ñ‹.")


import matplotlib.pyplot as plt


plt.rcParams['font.family'] = 'DejaVu Sans'  # Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ĞºĞ¸Ñ€Ğ¸Ğ»Ğ»Ğ¸Ñ†Ğ° Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¸Ğ»Ğ°ÑÑŒ

# 1. Ğ ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ vs ĞŸÑ€ĞµĞ´ÑĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ñ
plt.figure(figsize=(8, 5))
plt.scatter(y, y_pred, alpha=0.5, label='Ğ½Ğ°Ğ±Ğ»ÑĞ´ĞµĞ½Ğ¸Ñ', color="pink")
plt.plot([y.min(), y.max()], [y.min(), y.max()], 'r--', color="lime",label='Ğ¸Ğ´ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğµ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ğµ')
plt.xlabel("Ñ„Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ñ†ĞµĞ½Ğ°")
plt.ylabel("Ğ¿Ñ€ĞµĞ´ÑĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ°Ñ Ñ†ĞµĞ½Ğ°")
plt.title("ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ Ñ„Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¹ Ğ¸ Ğ¿Ñ€ĞµĞ´ÑĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾Ğ¹ Ñ†ĞµĞ½Ñ‹")
plt.legend()
plt.grid(True)
plt.tight_layout()
plt.savefig("task1_graphic.png")
plt.show()




